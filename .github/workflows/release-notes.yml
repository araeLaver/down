name: ðŸ“¢ ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ ìƒì„±

on:
  push:
    branches: [ master ]
    paths:
      - 'CHANGELOG.md'
  workflow_dispatch:

jobs:
  create-release-notes:
    runs-on: ubuntu-latest
    name: ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ ìžë™ ìƒì„±

    steps:
    - name: ðŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - name: ðŸ“‹ CHANGELOG ìµœì‹  í•­ëª© ì¶”ì¶œ
      id: extract-changelog
      run: |
        echo "## ðŸ“‹ ìµœì‹  ë³€ê²½ì‚¬í•­ (CHANGELOG.md)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        if [ -f "CHANGELOG.md" ]; then
          # ìµœì‹  ë²„ì „ ì„¹ì…˜ ì¶”ì¶œ (ì²« ë²ˆì§¸ ## ë¶€í„° ë‹¤ìŒ ## ì „ê¹Œì§€)
          LATEST_CHANGES=$(awk '/^## \[2025/{flag=1; next} /^## \[/{flag=0} flag' CHANGELOG.md | head -100)

          if [ -n "$LATEST_CHANGES" ]; then
            echo "$LATEST_CHANGES" >> $GITHUB_STEP_SUMMARY
          else
            echo "ìµœì‹  ë³€ê²½ì‚¬í•­ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤." >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "**âš ï¸ CHANGELOG.md íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤**" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY

    - name: ðŸ·ï¸ ë²„ì „ íƒœê·¸ ìƒì„± (ì„ íƒì )
      run: |
        echo "## ðŸ·ï¸ ë²„ì „ ì •ë³´" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        # ë‚ ì§œ ê¸°ë°˜ ë²„ì „ (ì˜ˆ: v2025.01.09)
        VERSION="v$(date +%Y.%m.%d)"
        echo "**ì œì•ˆ ë²„ì „:** $VERSION" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        # ìµœê·¼ íƒœê·¸ í™•ì¸
        LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "íƒœê·¸ ì—†ìŒ")
        echo "**ìµœê·¼ íƒœê·¸:** $LATEST_TAG" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

    - name: ðŸ“Š ì£¼ìš” ë³€ê²½ì‚¬í•­ ìš”ì•½
      run: |
        echo "## ðŸ“Š ì´ë²ˆ ë¦´ë¦¬ì¦ˆ ìš”ì•½" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        # ìµœê·¼ 5ê°œ ì»¤ë°‹ ë©”ì‹œì§€
        echo "### ìµœê·¼ ì»¤ë°‹ (ìµœëŒ€ 5ê°œ)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        git log -5 --pretty=format:"- **%s** (%ar) by %an" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

    - name: ðŸŽ¨ ì¹´í…Œê³ ë¦¬ë³„ ë³€ê²½ì‚¬í•­
      run: |
        echo "## ðŸŽ¨ ì¹´í…Œê³ ë¦¬ë³„ ë³€ê²½ì‚¬í•­" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        # ìµœê·¼ 10ê°œ ì»¤ë°‹ì—ì„œ ì¹´í…Œê³ ë¦¬ ì¶”ì¶œ
        echo "### âœ¨ ìƒˆë¡œìš´ ê¸°ëŠ¥" >> $GITHUB_STEP_SUMMARY
        git log -10 --pretty=format:"%s" | grep -iE "^(add|new|feat)" | sed 's/^/- /' >> $GITHUB_STEP_SUMMARY || echo "ì—†ìŒ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        echo "### ðŸ”§ ê°œì„ ì‚¬í•­" >> $GITHUB_STEP_SUMMARY
        git log -10 --pretty=format:"%s" | grep -iE "^(improve|enhance|update|redesign)" | sed 's/^/- /' >> $GITHUB_STEP_SUMMARY || echo "ì—†ìŒ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        echo "### ðŸ› ë²„ê·¸ ìˆ˜ì •" >> $GITHUB_STEP_SUMMARY
        git log -10 --pretty=format:"%s" | grep -iE "^(fix|bugfix)" | sed 's/^/- /' >> $GITHUB_STEP_SUMMARY || echo "ì—†ìŒ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        echo "### ðŸ“ ë¬¸ì„œí™”" >> $GITHUB_STEP_SUMMARY
        git log -10 --pretty=format:"%s" | grep -iE "^(doc|docs)" | sed 's/^/- /' >> $GITHUB_STEP_SUMMARY || echo "ì—†ìŒ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

    - name: ðŸ“ˆ í”„ë¡œì íŠ¸ í†µê³„
      run: |
        echo "## ðŸ“ˆ í”„ë¡œì íŠ¸ ì „ì²´ í†µê³„" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        # Python íŒŒì¼ ê°œìˆ˜
        PY_COUNT=$(find . -name "*.py" -not -path "./.git/*" | wc -l)
        echo "**Python íŒŒì¼:** $PY_COUNT ê°œ" >> $GITHUB_STEP_SUMMARY

        # HTML í…œí”Œë¦¿ ê°œìˆ˜
        HTML_COUNT=$(find . -name "*.html" -not -path "./.git/*" | wc -l)
        echo "**HTML í…œí”Œë¦¿:** $HTML_COUNT ê°œ" >> $GITHUB_STEP_SUMMARY

        # ì´ ì»¤ë°‹ ìˆ˜
        TOTAL_COMMITS=$(git rev-list --count HEAD)
        echo "**ì´ ì»¤ë°‹ ìˆ˜:** $TOTAL_COMMITS" >> $GITHUB_STEP_SUMMARY

        # ê¸°ì—¬ìž ìˆ˜
        CONTRIBUTORS=$(git log --format='%an' | sort -u | wc -l)
        echo "**ê¸°ì—¬ìž ìˆ˜:** $CONTRIBUTORS" >> $GITHUB_STEP_SUMMARY

        echo "" >> $GITHUB_STEP_SUMMARY

    - name: ðŸŽ‰ ë¦´ë¦¬ì¦ˆ ì™„ë£Œ
      run: |
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸŽ‰ ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ ìƒì„± ì™„ë£Œ!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ì´ ì •ë³´ëŠ” GitHub Actions ìš”ì•½ì—ì„œ í™•ì¸í•  ìˆ˜ ìžˆìŠµë‹ˆë‹¤." >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**ë°°í¬ ì¼ì‹œ:** $(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
        echo "**GitHub:** https://github.com/${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
