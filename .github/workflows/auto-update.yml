name: üìÖ ÏûêÎèô ÏóÖÎç∞Ïù¥Ìä∏ (ÏùºÏùº)

on:
  schedule:
    # Îß§Ïùº Ïò§Ï†Ñ 9Ïãú (KST)Ïóê Ïã§Ìñâ
    - cron: '0 0 * * *'
  workflow_dispatch:
    # ÏàòÎèô Ïã§Ìñâ Í∞ÄÎä•

jobs:
  daily-update:
    runs-on: ubuntu-latest
    name: ÏùºÏùº ÏûêÎèô ÏóÖÎç∞Ïù¥Ìä∏ Î∞è Î¶¨Ìè¨Ìä∏

    steps:
    - name: üì• Ï≤¥ÌÅ¨ÏïÑÏõÉ
      uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - name: üìä ÏùºÏùº ÌôúÎèô ÏöîÏïΩ
      run: |
        echo "## üìä ÏùºÏùº ÌîÑÎ°úÏ†ùÌä∏ ÌôúÎèô ÏöîÏïΩ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**ÎÇ†Ïßú:** $(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        # Ïò§Îäò Ïª§Î∞ã Ïàò
        TODAY=$(date '+%Y-%m-%d')
        TODAY_COMMITS=$(git log --since="$TODAY 00:00:00" --until="$TODAY 23:59:59" --oneline | wc -l)
        echo "**Ïò§Îäò Ïª§Î∞ã Ïàò:** $TODAY_COMMITS" >> $GITHUB_STEP_SUMMARY

        # ÏµúÍ∑º 3Í∞ú Ïª§Î∞ã
        if [ $TODAY_COMMITS -gt 0 ]; then
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ÏµúÍ∑º Ïª§Î∞ã" >> $GITHUB_STEP_SUMMARY
          git log --since="$TODAY 00:00:00" -3 --pretty=format:"- **%s** (%ar)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
        fi

        # Î≥ÄÍ≤ΩÎêú ÌååÏùº Ïàò
        if [ $TODAY_COMMITS -gt 0 ]; then
          CHANGED_FILES=$(git log --since="$TODAY 00:00:00" --name-only --pretty=format: | sort -u | grep -v '^$' | wc -l)
          echo "**Î≥ÄÍ≤ΩÎêú ÌååÏùº:** $CHANGED_FILES Í∞ú" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY

    - name: üìù README ÏóÖÎç∞Ïù¥Ìä∏ ÎÇ†Ïßú Í∞±Ïã†
      run: |
        current_date=$(date '+%Y-%m-%d')

        if [ -f "README.md" ]; then
          sed -i "s/ÎßàÏßÄÎßâ ÏóÖÎç∞Ïù¥Ìä∏: [0-9-]*/ÎßàÏßÄÎßâ ÏóÖÎç∞Ïù¥Ìä∏: $current_date/" README.md
          echo "‚úÖ README.md ÎÇ†Ïßú ÏóÖÎç∞Ïù¥Ìä∏: $current_date" >> $GITHUB_STEP_SUMMARY
        else
          echo "‚ö†Ô∏è README.md ÌååÏùºÏù¥ ÏóÜÏäµÎãàÎã§" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY

    - name: üìà ÌîÑÎ°úÏ†ùÌä∏ Í±¥Í∞ïÎèÑ Ï≤¥ÌÅ¨
      run: |
        echo "## üìà ÌîÑÎ°úÏ†ùÌä∏ Í±¥Í∞ïÎèÑ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        # Python ÌååÏùº Ï≤¥ÌÅ¨
        if ls *.py 1> /dev/null 2>&1; then
          PY_COUNT=$(find . -name "*.py" -not -path "./.git/*" | wc -l)
          echo "- ‚úÖ Python ÌååÏùº: $PY_COUNT Í∞ú" >> $GITHUB_STEP_SUMMARY
        fi

        # requirements.txt Ï≤¥ÌÅ¨
        if [ -f "requirements.txt" ]; then
          DEPS=$(wc -l < requirements.txt)
          echo "- ‚úÖ ÏùòÏ°¥ÏÑ±: $DEPS Í∞ú" >> $GITHUB_STEP_SUMMARY
        fi

        # CHANGELOG Ï≤¥ÌÅ¨
        if [ -f "CHANGELOG.md" ]; then
          echo "- ‚úÖ CHANGELOG.md Ï°¥Ïû¨" >> $GITHUB_STEP_SUMMARY
        else
          echo "- ‚ö†Ô∏è CHANGELOG.md ÏóÜÏùå" >> $GITHUB_STEP_SUMMARY
        fi

        # Î∞∞Ìè¨ ÏÑ§Ï†ï Ï≤¥ÌÅ¨
        if [ -f "Dockerfile" ] && [ -f "koyeb.yaml" ]; then
          echo "- ‚úÖ Î∞∞Ìè¨ ÏÑ§Ï†ï ÏôÑÎ£å" >> $GITHUB_STEP_SUMMARY
        fi

        echo "" >> $GITHUB_STEP_SUMMARY

    - name: üíæ Î≥ÄÍ≤ΩÏÇ¨Ìï≠ Ïª§Î∞ã
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action Bot"
        git add README.md

        if git diff --staged --quiet; then
          echo "## üìå Í≤∞Í≥º" >> $GITHUB_STEP_SUMMARY
          echo "Î≥ÄÍ≤ΩÏÇ¨Ìï≠ ÏóÜÏùå - Ïª§Î∞ã Ïä§ÌÇµ" >> $GITHUB_STEP_SUMMARY
        else
          COMMIT_MSG="üìÖ ÏûêÎèô ÏóÖÎç∞Ïù¥Ìä∏: $(date '+%Y-%m-%d') ÏùºÏùº Î¶¨Ìè¨Ìä∏ #${{ github.run_number }}"
          git commit -m "$COMMIT_MSG"
          git push

          echo "## ‚úÖ Ïª§Î∞ã ÏôÑÎ£å" >> $GITHUB_STEP_SUMMARY
          echo "**Î©îÏãúÏßÄ:** $COMMIT_MSG" >> $GITHUB_STEP_SUMMARY
        fi