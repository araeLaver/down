name: üìä Î∞∞Ìè¨ Î∞è Î≥ÄÍ≤ΩÏÇ¨Ìï≠ Ï∂îÏ†Å

on:
  push:
    branches: [ master ]
  workflow_dispatch:

jobs:
  track-changes:
    runs-on: ubuntu-latest
    name: Î≥ÄÍ≤ΩÏÇ¨Ìï≠ Î∂ÑÏÑù Î∞è Í∏∞Î°ù

    steps:
    - name: üì• ÏΩîÎìú Ï≤¥ÌÅ¨ÏïÑÏõÉ
      uses: actions/checkout@v3
      with:
        fetch-depth: 0  # Ï†ÑÏ≤¥ ÌûàÏä§ÌÜ†Î¶¨ Í∞ÄÏ†∏Ïò§Í∏∞

    - name: üìä Ïª§Î∞ã Ï†ïÎ≥¥ Î∂ÑÏÑù
      id: commit-info
      run: |
        echo "## üìã ÏµúÏã† Ïª§Î∞ã Ï†ïÎ≥¥" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        # Ïª§Î∞ã Ìï¥Ïãú
        COMMIT_SHA=$(git rev-parse HEAD)
        SHORT_SHA=$(git rev-parse --short HEAD)
        echo "**Ïª§Î∞ã Ìï¥Ïãú:** \`$SHORT_SHA\`" >> $GITHUB_STEP_SUMMARY

        # Ïª§Î∞ã Î©îÏãúÏßÄ
        COMMIT_MSG=$(git log -1 --pretty=%B)
        echo "**Ïª§Î∞ã Î©îÏãúÏßÄ:**" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        echo "$COMMIT_MSG" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        # ÏûëÏÑ±Ïûê Ï†ïÎ≥¥
        AUTHOR=$(git log -1 --pretty=format:'%an')
        DATE=$(git log -1 --pretty=format:'%ad' --date=format:'%Y-%m-%d %H:%M:%S')
        echo "**ÏûëÏÑ±Ïûê:** $AUTHOR" >> $GITHUB_STEP_SUMMARY
        echo "**ÎÇ†Ïßú:** $DATE" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

    - name: üìÅ Î≥ÄÍ≤ΩÎêú ÌååÏùº Î∂ÑÏÑù
      run: |
        echo "## üìÅ Î≥ÄÍ≤ΩÎêú ÌååÏùº" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        # Î≥ÄÍ≤ΩÎêú ÌååÏùº Î™©Î°ù
        git diff --name-status HEAD~1 HEAD > changed_files.txt || echo "ÏµúÏ¥à Ïª§Î∞ã" > changed_files.txt

        if [ -s changed_files.txt ]; then
          echo "| ÏÉÅÌÉú | ÌååÏùº Í≤ΩÎ°ú |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-----------|" >> $GITHUB_STEP_SUMMARY

          while IFS=$'\t' read -r status file; do
            case $status in
              A) STATUS_ICON="‚úÖ Ï∂îÍ∞Ä" ;;
              M) STATUS_ICON="‚úèÔ∏è ÏàòÏ†ï" ;;
              D) STATUS_ICON="‚ùå ÏÇ≠Ï†ú" ;;
              R*) STATUS_ICON="üìù Ïù¥Î¶ÑÎ≥ÄÍ≤Ω" ;;
              *) STATUS_ICON="$status" ;;
            esac
            echo "| $STATUS_ICON | \`$file\` |" >> $GITHUB_STEP_SUMMARY
          done < changed_files.txt
        else
          echo "Î≥ÄÍ≤ΩÎêú ÌååÏùºÏù¥ ÏóÜÏäµÎãàÎã§." >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY

    - name: üìà ÏΩîÎìú ÌÜµÍ≥Ñ
      run: |
        echo "## üìà ÏΩîÎìú Î≥ÄÍ≤Ω ÌÜµÍ≥Ñ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        # Î≥ÄÍ≤Ω ÌÜµÍ≥Ñ
        STATS=$(git diff --shortstat HEAD~1 HEAD 2>/dev/null || echo "ÌÜµÍ≥Ñ ÏóÜÏùå")
        echo "**Î≥ÄÍ≤Ω ÏöîÏïΩ:** $STATS" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        # ÌååÏùºÎ≥Ñ ÏÉÅÏÑ∏ ÌÜµÍ≥Ñ
        echo "### ÌååÏùºÎ≥Ñ ÏÉÅÏÑ∏ Î≥ÄÍ≤ΩÏÇ¨Ìï≠" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| ÌååÏùº | Ï∂îÍ∞Ä | ÏÇ≠Ï†ú |" >> $GITHUB_STEP_SUMMARY
        echo "|------|------|------|" >> $GITHUB_STEP_SUMMARY

        git diff --numstat HEAD~1 HEAD 2>/dev/null | while read added deleted file; do
          if [ "$added" != "-" ] && [ "$deleted" != "-" ]; then
            echo "| \`$file\` | +$added | -$deleted |" >> $GITHUB_STEP_SUMMARY
          fi
        done || echo "| - | - | - |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

    - name: üîç Python ÌååÏùº Î∂ÑÏÑù
      run: |
        echo "## üêç Python ÌååÏùº Î∂ÑÏÑù" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        PYTHON_FILES=$(git diff --name-only HEAD~1 HEAD 2>/dev/null | grep '\.py$' || echo "")

        if [ -n "$PYTHON_FILES" ]; then
          echo "**Î≥ÄÍ≤ΩÎêú Python ÌååÏùº:**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          for file in $PYTHON_FILES; do
            if [ -f "$file" ]; then
              LINES=$(wc -l < "$file" 2>/dev/null || echo "0")
              echo "- \`$file\` ($LINES Ï§Ñ)" >> $GITHUB_STEP_SUMMARY
            fi
          done
        else
          echo "Î≥ÄÍ≤ΩÎêú Python ÌååÏùºÏù¥ ÏóÜÏäµÎãàÎã§." >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY

    - name: üé® ÌÖúÌîåÎ¶ø ÌååÏùº Î∂ÑÏÑù
      run: |
        echo "## üé® ÌÖúÌîåÎ¶ø ÌååÏùº Î∂ÑÏÑù" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        HTML_FILES=$(git diff --name-only HEAD~1 HEAD 2>/dev/null | grep '\.html$' || echo "")

        if [ -n "$HTML_FILES" ]; then
          echo "**Î≥ÄÍ≤ΩÎêú HTML ÌÖúÌîåÎ¶ø:**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          for file in $HTML_FILES; do
            if [ -f "$file" ]; then
              LINES=$(wc -l < "$file" 2>/dev/null || echo "0")
              echo "- \`$file\` ($LINES Ï§Ñ)" >> $GITHUB_STEP_SUMMARY
            fi
          done
        else
          echo "Î≥ÄÍ≤ΩÎêú HTML ÌååÏùºÏù¥ ÏóÜÏäµÎãàÎã§." >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY

    - name: üì¶ ÏùòÏ°¥ÏÑ± Î≥ÄÍ≤Ω ÌôïÏù∏
      run: |
        echo "## üì¶ ÏùòÏ°¥ÏÑ± Î≥ÄÍ≤Ω ÌôïÏù∏" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        if git diff --name-only HEAD~1 HEAD 2>/dev/null | grep -q 'requirements.txt'; then
          echo "**‚ö†Ô∏è requirements.txt Î≥ÄÍ≤ΩÎê®**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`diff" >> $GITHUB_STEP_SUMMARY
          git diff HEAD~1 HEAD requirements.txt 2>/dev/null | grep -E '^\+|^\-' | grep -v '^\+\+\+\|^\-\-\-' >> $GITHUB_STEP_SUMMARY || echo "Î≥ÄÍ≤Ω ÏóÜÏùå" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        else
          echo "ÏùòÏ°¥ÏÑ± ÌååÏùº Î≥ÄÍ≤Ω ÏóÜÏùå" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY

    - name: üöÄ Î∞∞Ìè¨ ÏÑ§Ï†ï ÌôïÏù∏
      run: |
        echo "## üöÄ Î∞∞Ìè¨ ÏÑ§Ï†ï" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        DEPLOY_FILES_CHANGED=false

        for file in koyeb.yaml Dockerfile Procfile; do
          if git diff --name-only HEAD~1 HEAD 2>/dev/null | grep -q "$file"; then
            echo "**‚ö†Ô∏è $file Î≥ÄÍ≤ΩÎê®**" >> $GITHUB_STEP_SUMMARY
            DEPLOY_FILES_CHANGED=true
          fi
        done

        if [ "$DEPLOY_FILES_CHANGED" = false ]; then
          echo "Î∞∞Ìè¨ ÏÑ§Ï†ï ÌååÏùº Î≥ÄÍ≤Ω ÏóÜÏùå" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY

    - name: üìù CHANGELOG ÏóÖÎç∞Ïù¥Ìä∏ ÌôïÏù∏
      run: |
        echo "## üìù Î≥ÄÍ≤Ω Î°úÍ∑∏" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        if [ -f "CHANGELOG.md" ]; then
          echo "**CHANGELOG.md Ï°¥Ïû¨:** ‚úÖ" >> $GITHUB_STEP_SUMMARY

          if git diff --name-only HEAD~1 HEAD 2>/dev/null | grep -q 'CHANGELOG.md'; then
            echo "**ÏÉÅÌÉú:** Ïù¥Î≤à Ïª§Î∞ãÏóêÏÑú ÏóÖÎç∞Ïù¥Ìä∏Îê® ‚ú®" >> $GITHUB_STEP_SUMMARY
          else
            echo "**ÏÉÅÌÉú:** Î≥ÄÍ≤Ω ÏóÜÏùå" >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "**‚ö†Ô∏è CHANGELOG.md ÌååÏùºÏù¥ ÏóÜÏäµÎãàÎã§**" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY

    - name: üéØ Î∞∞Ìè¨ ÏÉÅÌÉú ÏöîÏïΩ
      run: |
        echo "## üéØ Î∞∞Ìè¨ Ï§ÄÎπÑ ÏÉÅÌÉú" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        # Ï≤¥ÌÅ¨Î¶¨Ïä§Ìä∏
        echo "### Ï≤¥ÌÅ¨Î¶¨Ïä§Ìä∏" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        # Python ÌååÏùº Ï≤¥ÌÅ¨
        if ls *.py 1> /dev/null 2>&1; then
          echo "- ‚úÖ Python ÌååÏùº Ï°¥Ïû¨" >> $GITHUB_STEP_SUMMARY
        fi

        # requirements.txt Ï≤¥ÌÅ¨
        if [ -f "requirements.txt" ]; then
          DEPS_COUNT=$(wc -l < requirements.txt)
          echo "- ‚úÖ requirements.txt ($DEPS_COUNT Í∞ú ÏùòÏ°¥ÏÑ±)" >> $GITHUB_STEP_SUMMARY
        fi

        # Dockerfile Ï≤¥ÌÅ¨
        if [ -f "Dockerfile" ]; then
          echo "- ‚úÖ Dockerfile Ï°¥Ïû¨" >> $GITHUB_STEP_SUMMARY
        fi

        # koyeb.yaml Ï≤¥ÌÅ¨
        if [ -f "koyeb.yaml" ]; then
          echo "- ‚úÖ koyeb.yaml Ï°¥Ïû¨" >> $GITHUB_STEP_SUMMARY
        fi

        # CHANGELOG Ï≤¥ÌÅ¨
        if [ -f "CHANGELOG.md" ]; then
          echo "- ‚úÖ CHANGELOG.md Ï°¥Ïû¨" >> $GITHUB_STEP_SUMMARY
        fi

        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Î∞∞Ìè¨ Ï§ÄÎπÑ ÏôÑÎ£å!** üöÄ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "GitHub Ïª§Î∞ã: [\`$(git rev-parse --short HEAD)\`](https://github.com/${{ github.repository }}/commit/$(git rev-parse HEAD))" >> $GITHUB_STEP_SUMMARY
